name: OpenClaw

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Node
        run: |
          sudo apt-get update -qq
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs wget

      - name: Install OpenClaw (non-interactive)
        run: |
          npm config set prefix ~/.npm-global
          export PATH=~/.npm-global/bin:$PATH
          npm install -g openclaw
          echo "$HOME/.npm-global/bin" >> $GITHUB_PATH

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start OpenClaw
        run: |
          nohup openclaw > openclaw.log 2>&1 &
          sleep 10
          sudo lsof -i -P -n | grep LISTEN || true

      - name: Start Tunnel
        run: |
          PORT=$(sudo lsof -i -P -n | grep LISTEN | grep node | awk '{print $9}' | sed 's/.*://')
          echo "Detected Port: $PORT"
          cloudflared tunnel --url http://localhost:$PORT > tunnel.log 2>&1 &
          sleep 10
          grep -o 'https://[a-zA-Z0-9\-]*\.trycloudflare\.com' tunnel.log || echo "Tunnel not found"

      - name: Keep Alive
        run: sleep 21600
